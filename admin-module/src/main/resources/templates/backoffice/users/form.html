<!DOCTYPE html>
<html lang="es" xmlns:th="http://www.thymeleaf.org">
<th:block th:replace="~{backoffice/layout :: layout(#{admin.users.title}, ~{::headerActions}, ~{::content})}">
    <th:block th:fragment="headerActions"></th:block>

    <th:block th:fragment="content">
        <section class="p-6 lg:p-8 max-w-5xl mx-auto">
            <nav class="text-sm text-[#956d50] mb-6">
                <a href="/admin/users" class="hover:text-[#8b4513]" th:text="#{admin.users.form.breadcrumb}">User Management</a>
                <span class="mx-2">/</span>
                <span th:if="${!isEdit}" th:text="#{admin.users.create.title}">Create admin user</span>
                <span th:if="${isEdit}" th:text="#{admin.users.edit.title}">Edit admin user</span>
            </nav>

            <div th:if="${errorMessage}" class="mb-4 rounded-lg border border-red-200 bg-red-50 px-4 py-3 text-sm text-red-700" th:text="${errorMessage}"></div>

            <form th:action="${formAction}" method="post" class="bg-white border border-[#e6dad1] rounded-xl overflow-hidden">
                <div class="p-6 border-b border-[#e6dad1]">
                    <h3 class="text-lg font-bold" th:text="#{admin.users.form.section.details}">Admin User Details</h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mt-4">
                        <label class="block">
                            <span class="text-sm font-semibold" th:text="#{admin.users.form.email}">Email Address</span>
                            <input name="email" type="email" class="mt-2 w-full rounded-lg border-[#e6dad1]" th:placeholder="#{admin.login.email.placeholder}" th:value="${email}" required>
                            <span th:if="${emailError}" class="mt-2 block text-xs font-semibold text-red-700" th:text="${emailError}"></span>
                        </label>
                        <label class="block">
                            <span class="text-sm font-semibold" th:text="#{admin.users.form.domain}">Domain</span>
                            <input type="text" class="mt-2 w-full rounded-lg border-[#e6dad1] bg-[#f8f7f6]" th:value="${domainCode}" readonly>
                            <span class="mt-2 block text-xs text-[#956d50]" th:text="#{admin.users.form.domain.locked}">Domain is fixed after creation.</span>
                        </label>
                    </div>
                </div>

                <div class="p-6 border-b border-[#e6dad1]">
                    <h3 class="text-lg font-bold" th:text="#{admin.users.form.section.role}">Role and Permissions</h3>
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mt-4">
                        <label class="block">
                            <span class="text-sm font-semibold" th:text="#{admin.users.form.role}">Role</span>
                            <select id="roleCode" name="roleCode" class="mt-2 w-full rounded-lg border-[#e6dad1]" required>
                                <option value="" th:text="#{admin.users.form.role.select}">Select a role</option>
                                <option
                                    th:each="role : ${roles}"
                                    th:value="${role.code()}"
                                    th:text="|${role.name()} (${role.code()})|"
                                    th:selected="${selectedRoleCode == role.code()}"
                                    th:attr="data-permissions=${#strings.listJoin(role.permissions(), ';;')}"
                                >manage-users</option>
                            </select>
                            <span th:if="${roleError}" class="mt-2 block text-xs font-semibold text-red-700" th:text="${roleError}"></span>
                        </label>

                        <div>
                            <span class="text-sm font-semibold" th:text="#{admin.users.form.permission.preview}">Permission Preview</span>
                            <ul id="rolePermissionPreview" class="mt-2 text-sm text-[#956d50] list-disc pl-5 space-y-1" th:attr="data-empty-text=#{admin.users.form.permission.empty}">
                                <li th:text="#{admin.users.form.permission.empty}">Select a role to preview permissions.</li>
                            </ul>
                        </div>
                    </div>
                </div>

                <div class="p-6 border-b border-[#e6dad1]">
                    <h3 class="text-lg font-bold" th:text="#{admin.users.form.section.security}">Security</h3>
                    <label class="block mt-4 max-w-md">
                        <span class="text-sm font-semibold" th:text="${isEdit} ? #{admin.users.form.password.edit} : #{admin.users.form.password}">Password</span>
                        <input name="password" type="password" class="mt-2 w-full rounded-lg border-[#e6dad1]" th:placeholder="#{admin.users.form.password.placeholder}" th:required="${!isEdit}">
                        <span th:if="${passwordError}" class="mt-2 block text-xs font-semibold text-red-700" th:text="${passwordError}"></span>
                    </label>
                </div>

                <div class="p-6 flex items-center justify-between">
                    <p class="text-sm text-[#956d50]" th:if="${isEdit}" th:text="#{admin.users.editing(${userId})}"></p>
                    <div class="ml-auto space-x-3">
                        <a href="/admin/users" class="px-5 py-2.5 text-sm font-bold text-[#956d50]" th:text="#{admin.users.form.cancel}">Cancel</a>
                        <button type="submit" class="px-6 py-2.5 text-sm font-bold text-white bg-[#8b4513] rounded-lg" th:text="${isEdit} ? #{admin.users.submit.edit} : #{admin.users.submit.create}">Save User</button>
                    </div>
                </div>
            </form>
        </section>

        <script>
            (function () {
                var roleSelect = document.getElementById("roleCode");
                var previewList = document.getElementById("rolePermissionPreview");
                if (!roleSelect || !previewList) {
                    return;
                }

                var emptyText = previewList.getAttribute("data-empty-text") || "Select a role to preview permissions.";

                function renderPermissions() {
                    var selected = roleSelect.options[roleSelect.selectedIndex];
                    var raw = selected ? selected.getAttribute("data-permissions") : "";
                    var items = raw ? raw.split(";;").filter(Boolean) : [];

                    previewList.innerHTML = "";
                    if (!items.length) {
                        var emptyItem = document.createElement("li");
                        emptyItem.textContent = emptyText;
                        previewList.appendChild(emptyItem);
                        return;
                    }

                    items.forEach(function (permission) {
                        var li = document.createElement("li");
                        li.textContent = permission;
                        previewList.appendChild(li);
                    });
                }

                roleSelect.addEventListener("change", renderPermissions);
                renderPermissions();
            })();
        </script>
    </th:block>
</th:block>
</html>
