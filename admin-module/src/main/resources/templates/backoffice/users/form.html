<!DOCTYPE html>
<html lang="es" xmlns:th="http://www.thymeleaf.org">
<th:block th:replace="~{backoffice/layout :: layout(${pageTitle}, ~{::headerActions}, ~{::content})}">
    <th:block th:fragment="headerActions"></th:block>

    <th:block th:fragment="content">
        <section class="p-6 lg:p-8 max-w-5xl mx-auto">
            <nav class="text-sm text-[#956d50] mb-6">
                <a href="/admin/users" class="hover:text-[#8b4513]">User Management</a>
                <span class="mx-2">/</span>
                <span th:text="${pageTitle}">Crear usuario admin</span>
            </nav>

            <div th:if="${errorMessage}" class="mb-4 rounded-lg border border-red-200 bg-red-50 px-4 py-3 text-sm text-red-700" th:text="${errorMessage}"></div>

            <form th:action="${formAction}" method="post" class="bg-white border border-[#e6dad1] rounded-xl overflow-hidden">
                <div class="p-6 border-b border-[#e6dad1]">
                    <h3 class="text-lg font-bold">Admin User Details</h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mt-4">
                        <label class="block">
                            <span class="text-sm font-semibold">Email Address</span>
                            <input name="email" type="email" class="mt-2 w-full rounded-lg border-[#e6dad1]" placeholder="jane.doe@crumblycookies.com" th:value="${email}" required>
                            <span th:if="${emailError}" class="mt-2 block text-xs font-semibold text-red-700" th:text="${emailError}"></span>
                        </label>
                        <label class="block">
                            <span class="text-sm font-semibold">Domain</span>
                            <input type="text" class="mt-2 w-full rounded-lg border-[#e6dad1] bg-[#f8f7f6]" th:value="${domainCode}" readonly>
                            <span class="mt-2 block text-xs text-[#956d50]">Domain is fixed after creation.</span>
                        </label>
                    </div>
                </div>

                <div class="p-6 border-b border-[#e6dad1]">
                    <h3 class="text-lg font-bold">Role & Permissions</h3>
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mt-4">
                        <label class="block">
                            <span class="text-sm font-semibold">Role</span>
                            <select id="roleCode" name="roleCode" class="mt-2 w-full rounded-lg border-[#e6dad1]" required>
                                <option value="">Select a role</option>
                                <option
                                    th:each="role : ${roles}"
                                    th:value="${role.code()}"
                                    th:text="|${role.name()} (${role.code()})|"
                                    th:selected="${selectedRoleCode == role.code()}"
                                    th:attr="data-permissions=${#strings.listJoin(role.permissions(), ';;')}"
                                >manage-users</option>
                            </select>
                            <span th:if="${roleError}" class="mt-2 block text-xs font-semibold text-red-700" th:text="${roleError}"></span>
                        </label>

                        <div>
                            <span class="text-sm font-semibold">Permission Preview</span>
                            <ul id="rolePermissionPreview" class="mt-2 text-sm text-[#956d50] list-disc pl-5 space-y-1">
                                <li>Select a role to preview permissions.</li>
                            </ul>
                        </div>
                    </div>
                </div>

                <div class="p-6 border-b border-[#e6dad1]">
                    <h3 class="text-lg font-bold">Security</h3>
                    <label class="block mt-4 max-w-md">
                        <span class="text-sm font-semibold" th:text="${isEdit} ? \"Password (leave blank to keep current)\" : \"Password\"">Password</span>
                        <input name="password" type="password" class="mt-2 w-full rounded-lg border-[#e6dad1]" placeholder="Min. 8 characters" th:required="${!isEdit}">
                        <span th:if="${passwordError}" class="mt-2 block text-xs font-semibold text-red-700" th:text="${passwordError}"></span>
                    </label>
                </div>

                <div class="p-6 flex items-center justify-between">
                    <p class="text-sm text-[#956d50]" th:if="${isEdit}" th:text="\"Editando usuario #\" + ${userId}"></p>
                    <div class="ml-auto space-x-3">
                        <a href="/admin/users" class="px-5 py-2.5 text-sm font-bold text-[#956d50]">Cancel</a>
                        <button type="submit" class="px-6 py-2.5 text-sm font-bold text-white bg-[#8b4513] rounded-lg" th:text="${submitLabel}">Save User</button>
                    </div>
                </div>
            </form>
        </section>

        <script>
            (function () {
                var roleSelect = document.getElementById("roleCode");
                var previewList = document.getElementById("rolePermissionPreview");
                if (!roleSelect || !previewList) {
                    return;
                }

                function renderPermissions() {
                    var selected = roleSelect.options[roleSelect.selectedIndex];
                    var raw = selected ? selected.getAttribute("data-permissions") : "";
                    var items = raw ? raw.split(";;").filter(Boolean) : [];

                    previewList.innerHTML = "";
                    if (!items.length) {
                        var emptyItem = document.createElement("li");
                        emptyItem.textContent = "Select a role to preview permissions.";
                        previewList.appendChild(emptyItem);
                        return;
                    }

                    items.forEach(function (permission) {
                        var li = document.createElement("li");
                        li.textContent = permission;
                        previewList.appendChild(li);
                    });
                }

                roleSelect.addEventListener("change", renderPermissions);
                renderPermissions();
            })();
        </script>
    </th:block>
</th:block>
</html>
